version: '3.8'

services:
  db:
      image: postgres:15-alpine
          environment:
                POSTGRES_DB: n8n
                      POSTGRES_USER: n8n
                            POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me}
                                volumes:
                                      - db_data:/var/lib/postgresql/data
                                          networks:
                                                - automation_network
                                                    restart: unless-stopped
                                                        healthcheck:
                                                              test: ["CMD-SHELL", "pg_isready -U n8n"]
                                                                    interval: 10s
                                                                          timeout: 5s
                                                                                retries: 5

                                                                                  n8n:
                                                                                      image: n8n:latest
                                                                                          depends_on:
                                                                                                db:
                                                                                                        condition: service_healthy
                                                                                                            environment:
                                                                                                                  DB_TYPE: postgresdb
                                                                                                                        DB_POSTGRESDB_HOST: db
                                                                                                                              DB_POSTGRESDB_PORT: 5432
                                                                                                                                    DB_POSTGRESDB_DATABASE: n8n
                                                                                                                                          DB_POSTGRESDB_USER: n8n
                                                                                                                                                DB_POSTGRESDB_PASSWORD: ${DB_PASSWORD:-change_me}
                                                                                                                                                      N8N_HOST: ${N8N_HOST:-localhost}
                                                                                                                                                            N8N_PORT: 5678
                                                                                                                                                                  N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
                                                                                                                                                                        WEBHOOK_URL: ${WEBHOOK_URL:-http://localhost:5678}
                                                                                                                                                                              WAHA_API_URL: http://waha:3000
                                                                                                                                                                                    NODE_ENV: production
                                                                                                                                                                                          NODE_OPTIONS: --max-old-space-size=512
                                                                                                                                                                                              volumes:
                                                                                                                                                                                                    - n8n_data:/home/node/.n8n
                                                                                                                                                                                                        networks:
                                                                                                                                                                                                              - automation_network
                                                                                                                                                                                                                  ports:
                                                                                                                                                                                                                        - "5678:5678"
                                                                                                                                                                                                                            restart: unless-stopped
                                                                                                                                                                                                                                healthcheck:
                                                                                                                                                                                                                                      test: ["CMD", "curl", "-f", "http://localhost:5678/api/v1/health"]
                                                                                                                                                                                                                                            interval: 30s
                                                                                                                                                                                                                                                  timeout: 10s
                                                                                                                                                                                                                                                        retries: 3
                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                          waha:
                                                                                                                                                                                                                                                              image: devlikeapro/waha:latest
                                                                                                                                                                                                                                                                  environment:
                                                                                                                                                                                                                                                                        WHATSAPP_RESTART_ALL_INSTANCES: 'true'
                                                                                                                                                                                                                                                                              WHATSAPP_HOOK_EVENTS: message,status_ack,presence
                                                                                                                                                                                                                                                                                    WAHA_API_KEY: ${WAHA_API_KEY:-your_secure_key}
                                                                                                                                                                                                                                                                                          NODE_ENV: production
                                                                                                                                                                                                                                                                                                NODE_OPTIONS: --max-old-space-size=256
                                                                                                                                                                                                                                                                                                    volumes:
                                                                                                                                                                                                                                                                                                          - waha_sessions:/app/sessions
                                                                                                                                                                                                                                                                                                                - waha_media:/app/media
                                                                                                                                                                                                                                                                                                                    networks:
                                                                                                                                                                                                                                                                                                                          - automation_network
                                                                                                                                                                                                                                                                                                                              ports:
                                                                                                                                                                                                                                                                                                                                    - "3000:3000"
                                                                                                                                                                                                                                                                                                                                        restart: unless-stopped
                                                                                                                                                                                                                                                                                                                                            healthcheck:
                                                                                                                                                                                                                                                                                                                                                  test: ["CMD", "curl", "-f", "-H", "X-API-Key: ${WAHA_API_KEY:-your_secure_key}", "http://localhost:3000/api/info"]
                                                                                                                                                                                                                                                                                                                                                        interval: 30s
                                                                                                                                                                                                                                                                                                                                                              timeout: 10s
                                                                                                                                                                                                                                                                                                                                                                    retries: 3
                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                    volumes:
                                                                                                                                                                                                                                                                                                                                                                      db_data:
                                                                                                                                                                                                                                                                                                                                                                          driver: local
                                                                                                                                                                                                                                                                                                                                                                            n8n_data:
                                                                                                                                                                                                                                                                                                                                                                                driver: local
                                                                                                                                                                                                                                                                                                                                                                                  waha_sessions:
                                                                                                                                                                                                                                                                                                                                                                                      driver: local
                                                                                                                                                                                                                                                                                                                                                                                        waha_media:
                                                                                                                                                                                                                                                                                                                                                                                            driver: local
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            networks:
                                                                                                                                                                                                                                                                                                                                                                                              automation_network:
                                                                                                                                                                                                                                                                                                                                                                                                  driver: bridge
